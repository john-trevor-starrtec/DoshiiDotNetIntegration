<?xml version="1.0"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title></title>
</head>
<body>
<div class="wsd" wsd_style="modern-blue">
<pre>

title OrderCreate-OrderStatus Notification

participant POS
participant DoshiiHttp
participant DoshiiSockets

DoshiiSockets->POS:  Notification. \n the orderCreate and the Order Status notification \n contain an orderId and a status 
POS->DoshiiHttp: get order from Doshii. \n GET ../orders/:id
DoshiiHttp->POS: returns order object
POS->POS: recorded order.UpdatedAt string.
alt orderStatus = cancelled
	POS->POS: cancel the order on the POS
else orderStatus = readyToPay
	POS->POS: confirm the order totals on the received order are correct.
	alt order is correct
		POS->DoshiiHttp: Request payment for of order. \n PUT ../orders/:id \n order status = waiting for payment
	else order is incorrect
		POS->POS: update order object with current order data. 
		POS->DoshiiHttp: Request payment for of order. \n PUT ../orders/:id \n order status = waiting for payment
	end
else orderStatus = new or pending
	alt bistroMode
		POS->POS: confirm availability of order on the pos. \n as this is bistro mode the order should NOT be completed on the pos at this stage. \n individual items on the order can be accepted or rejected by the pos and rejection reasons supplied. \n if any item is rejected the order availability fails.
		alt order availability confirmed
			POS->DoshiiHttp: accept order on Doshii. \n PUT ../orders/:id \n order status = accepted
			DoshiiHttp->POS: successful response, the order is returned with a new UpdatedAt string
			POS->POS: record the UpdatedAt string
			POS->DoshiiHttp: request payment for the order. \n PUT ../orders/:id \n order status = waitingForPayment
			DoshiiHttp->POS: an order object is returned. 
			POS->POS: check the order is fully paid
			alt order is not fully paid
				POS->POS: DO NOT process this order, \n partial payments are not supported in bistro mode and there has been a problem in the system. 
			else order is fully paid 
				POS->POS: order the line items in the order.
				POS->POS: record payment for the order. 
			end 
		else order availability failed
			POS->DoshiiHttp: reject order on Doshii. \n PUT ../orders/:id \n order status = rejected
			DoshiiHttp->POS: order is returned with new UpdatedAt
			POS->POS: record the UpdatedAt string.
		end 
	else resturantMode
		POS->POS: confirm availability of the order on the pos. \n as this is restaurant mode the order should be completed on the pos at this stage. \n individual items on the order can be accepted or rejected by the pos and rejection reasons supplied. \n if any item is rejected the order availability fails.
		alt order availability confirmed
			POS->POS: generate the order on the pos
			POS->DoshiiHttp: accept order on Doshii. \n PUT ../orders/:id \n order status = accepted
			DoshiiHttp->POS: order is returned with new UpdatedAt
			POS->POS: record the UpdatedAt string.
		else order availability failed.
			POS->DoshiiHttp: reject order on Doshii. \n PUT ../orders/:id \n order status = rejected
			DoshiiHttp->POS: order is returned with new UpdatedAt
			POS->POS: record the UpdatedAt string.
		end
	end
else 
end

</pre>
</div>
<script type="text/javascript" src="http://www.websequencediagrams.com/service.js"></script>
</body>
</html>